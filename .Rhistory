#currentDataset$sex[currentDataset$rand > 0.8 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$partnered[currentDataset$rand > 0.95 & currentDataset$sex == 0] = NA
currentDataset$partnered[currentDataset$rand > 0.85 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$language[currentDataset$rand > 0.85 & currentDataset$partnered == 0] = NA
currentDataset$language[currentDataset$rand > 0.8 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$high_school[currentDataset$rand > 0.85 & currentDataset$partnered == 0] = NA
currentDataset$high_school[currentDataset$rand > 0.8 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$risky_alcohol[currentDataset$rand > 0.95 & currentDataset$remoteness == 0] = NA
currentDataset$risky_alcohol[currentDataset$rand > 0.8 & currentDataset$remoteness == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$smoker[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0] = NA
currentDataset$smoker[currentDataset$rand > 0.8 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$age[currentDataset$rand > 0.8 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$age[currentDataset$rand > 0.7 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$indigeneity[currentDataset$rand > 0.8 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$indigeneity[currentDataset$rand > 0.7 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
md.pattern(currentDataset)
currentDataset <- read_csv("https://raw.githubusercontent.com/gckc123/Causal_Analysis_Addiction_Examples/main/smoking_psyc_distress.csv")
set.seed(12345)
library(mice)
md.pattern(currentDataset)
#currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$sex[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 0] = NA
currentDataset$sex[currentDataset$rand > 0.8 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$partnered[currentDataset$rand > 0.95 & currentDataset$sex == 0] = NA
currentDataset$partnered[currentDataset$rand > 0.85 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$language[currentDataset$rand > 0.85 & currentDataset$partnered == 0] = NA
currentDataset$language[currentDataset$rand > 0.8 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$high_school[currentDataset$rand > 0.85 & currentDataset$partnered == 0] = NA
currentDataset$high_school[currentDataset$rand > 0.8 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$risky_alcohol[currentDataset$rand > 0.95 & currentDataset$remoteness == 0] = NA
currentDataset$risky_alcohol[currentDataset$rand > 0.8 & currentDataset$remoteness == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$smoker[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0] = NA
currentDataset$smoker[currentDataset$rand > 0.8 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$age[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$age[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$indigeneity[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$indigeneity[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
md.pattern(currentDataset)
currentDataset <- read_csv("https://raw.githubusercontent.com/gckc123/Causal_Analysis_Addiction_Examples/main/smoking_psyc_distress.csv")
set.seed(12345)
library(mice)
md.pattern(currentDataset)
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$sex[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 0] = NA
currentDataset$sex[currentDataset$rand > 0.8 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$partnered[currentDataset$rand > 0.95 & currentDataset$sex == 0] = NA
currentDataset$partnered[currentDataset$rand > 0.85 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$language[currentDataset$rand > 0.85 & currentDataset$partnered == 0] = NA
currentDataset$language[currentDataset$rand > 0.8 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$high_school[currentDataset$rand > 0.85 & currentDataset$partnered == 0] = NA
currentDataset$high_school[currentDataset$rand > 0.8 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$risky_alcohol[currentDataset$rand > 0.95 & currentDataset$remoteness == 0] = NA
currentDataset$risky_alcohol[currentDataset$rand > 0.8 & currentDataset$remoteness == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$smoker[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0] = NA
currentDataset$smoker[currentDataset$rand > 0.8 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$age[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$age[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$indigeneity[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$indigeneity[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
md.pattern(currentDataset)
currentDataset <- read_csv("https://raw.githubusercontent.com/gckc123/Causal_Analysis_Addiction_Examples/main/smoking_psyc_distress.csv")
set.seed(12345)
library(mice)
md.pattern(currentDataset)
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$sex[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0] = NA
currentDataset$sex[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$partnered[currentDataset$rand > 0.95 & currentDataset$sex == 0] = NA
currentDataset$partnered[currentDataset$rand > 0.85 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$language[currentDataset$rand > 0.95 & currentDataset$partnered == 0] = NA
currentDataset$language[currentDataset$rand > 0.85 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$high_school[currentDataset$rand > 0.95 & currentDataset$partnered == 0] = NA
currentDataset$high_school[currentDataset$rand > 0.85 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$risky_alcohol[currentDataset$rand > 0.95 & currentDataset$remoteness == 0] = NA
currentDataset$risky_alcohol[currentDataset$rand > 0.85 & currentDataset$remoteness == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$smoker[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0] = NA
currentDataset$smoker[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$age[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$age[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$indigeneity[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$indigeneity[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$pysc_distress[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1 & currentDataset$smoker == 0] = NA
currentDataset$psyc_distress[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0 & currentDataset$smoker == 1] = NA
md.pattern(currentDataset)
currentDataset <- read_csv("https://raw.githubusercontent.com/gckc123/Causal_Analysis_Addiction_Examples/main/smoking_psyc_distress.csv")
set.seed(12345)
library(mice)
md.pattern(currentDataset)
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$sex[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0] = NA
currentDataset$sex[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$partnered[currentDataset$rand > 0.95 & currentDataset$sex == 0] = NA
currentDataset$partnered[currentDataset$rand > 0.85 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$language[currentDataset$rand > 0.95 & currentDataset$partnered == 0] = NA
currentDataset$language[currentDataset$rand > 0.85 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$high_school[currentDataset$rand > 0.95 & currentDataset$partnered == 0] = NA
currentDataset$high_school[currentDataset$rand > 0.85 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$risky_alcohol[currentDataset$rand > 0.95 & currentDataset$remoteness == 0] = NA
currentDataset$risky_alcohol[currentDataset$rand > 0.85 & currentDataset$remoteness == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$smoker[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0] = NA
currentDataset$smoker[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$age[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$age[currentDataset$rand > 0.85 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$indigeneity[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$indigeneity[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$psyc_distress[currentDataset$rand > 0.95 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1 & currentDataset$smoker == 0] = NA
currentDataset$psyc_distress[currentDataset$rand > 0.9 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0 & currentDataset$smoker == 1] = NA
md.pattern(currentDataset)
currentDataset <- read_csv("https://raw.githubusercontent.com/gckc123/Causal_Analysis_Addiction_Examples/main/smoking_psyc_distress.csv")
set.seed(12345)
library(mice)
md.pattern(currentDataset)
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$sex[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0] = NA
currentDataset$sex[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$partnered[currentDataset$rand > 0.96 & currentDataset$sex == 0] = NA
currentDataset$partnered[currentDataset$rand > 0.88 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$language[currentDataset$rand > 0.96 & currentDataset$partnered == 0] = NA
currentDataset$language[currentDataset$rand > 0.88 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$high_school[currentDataset$rand > 0.96 & currentDataset$partnered == 0] = NA
currentDataset$high_school[currentDataset$rand > 0.88 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$risky_alcohol[currentDataset$rand > 0.96 & currentDataset$remoteness == 0] = NA
currentDataset$risky_alcohol[currentDataset$rand > 0.88 & currentDataset$remoteness == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$smoker[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0] = NA
currentDataset$smoker[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$age[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$age[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$indigeneity[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$indigeneity[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$psyc_distress[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1 & currentDataset$smoker == 0] = NA
currentDataset$psyc_distress[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0 & currentDataset$smoker == 1] = NA
md.pattern(currentDataset)
library(mice)
imp <- mice(currentDataset, m = 40)
cl <- parallel::makeCluster(detectCores()-1)
doParallel::registerDoParallel(cl)
currentDataset <- complete(imp, action = "long", include = TRUE)
match_obj <- NULL
res <- NULL
covar <- NULL
b <- data.frame()
m <- imp$m
coeftest_obj <- NULL
boot_res = NULL
matched_data <-NULL
for (i in (1:imp$m)) {
match_obj[[i]] <- matchit(smoker ~ sex + indigeneity + high_school + partnered + remoteness + risky_alcohol + age + language,
data = currentDataset[currentDataset$.imp == i, ], method = "nearest", distance ="glm")
matched_data[[i]] <- match.data(match_obj[[i]])
res[[i]] <- lm(psyc_distress ~ smoker, data = matched_data[[i]], weights =weights)
#coeftest_obj[[i]] <- coeftest(res[[i]], vcov. = vcovCL, cluster =~subclass)
b <- rbind(b, res[[i]]$coefficients)
covar[[i]] <- vcovCL(res[[i]], cluster =~ subclass)
pair_ids <- levels(matched_data[[i]]$subclass)
boot_n <- 2000
boot_res[[i]] <- foreach (k = (1:boot_n), .combine = 'rbind') %dopar% {
boot_sample_ids <- sample(pair_ids, replace = TRUE)
num_present_in_boot_sample <- table(boot_sample_ids)
ids <- unlist(lapply(pair_ids[pair_ids %in% names(num_present_in_boot_sample)],
function(p) rep(which(matched_data[[i]]$subclass == p),
num_present_in_boot_sample[p])))
boot_data <- matched_data[[i]][ids, ]
#print(boot_data)
boot_fit <- lm(psyc_distress ~ smoker , data = boot_data, weights = weights)
boot_fit$coefficients
}
boot_res[[i]] <- data.frame(boot_res[[i]])
print(i)
}
boot_res_combined <- bind_rows(boot_res, .id = NULL)
sapply(boot_res_combined, quantile, c(0.025,  0.975))
colnames(b) <- attributes(res[[1]]$coefficients)$names
U_bar <- Reduce("+", covar)/m
U_bar <- diag(U_bar)
B <- sapply(b, var)
T <- U_bar + (1 + 1/m)*B
SE <- T^0.5
est <- data.frame(var = names(b))
est$b <- sapply(b, mean)
est$SE <- SE
est$z <- est$b/est$SE
est$p_value <- pnorm(abs(est$z), lower.tail = FALSE)*2
est
currentDataset <- read_csv("https://raw.githubusercontent.com/gckc123/Causal_Analysis_Addiction_Examples/main/smoking_psyc_distress.csv")
set.seed(12345)
library(mice)
md.pattern(currentDataset)
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$sex[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0] = NA
currentDataset$sex[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$partnered[currentDataset$rand > 0.96 & currentDataset$sex == 0] = NA
currentDataset$partnered[currentDataset$rand > 0.88 & currentDataset$sex == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$language[currentDataset$rand > 0.96 & currentDataset$partnered == 0] = NA
currentDataset$language[currentDataset$rand > 0.88 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$high_school[currentDataset$rand > 0.96 & currentDataset$partnered == 0] = NA
currentDataset$high_school[currentDataset$rand > 0.88 & currentDataset$partnered == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$risky_alcohol[currentDataset$rand > 0.96 & currentDataset$remoteness == 0] = NA
currentDataset$risky_alcohol[currentDataset$rand > 0.88 & currentDataset$remoteness == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$smoker[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0] = NA
currentDataset$smoker[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$age[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$age[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$rand = runif(length(currentDataset$sex))
currentDataset$indigeneity[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1] = NA
currentDataset$indigeneity[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0] = NA
currentDataset$psyc_distress[currentDataset$rand > 0.96 & currentDataset$risky_alcohol == 0 & currentDataset$partnered == 1 & currentDataset$smoker == 0] = NA
currentDataset$psyc_distress[currentDataset$rand > 0.88 & currentDataset$risky_alcohol == 1 & currentDataset$partnered == 0 & currentDataset$smoker == 1] = NA
md.pattern(currentDataset)
currentDataset <- read_csv("https://raw.githubusercontent.com/gckc123/Causal_Analysis_Addiction_Examples/main/smoking_psyc_distress.csv")
match_obj <- matchit(smoker ~ sex + indigeneity + high_school + partnered + remoteness + risky_alcohol + age + language,
data = currentDataset, method = "nearest", distance ="glm")
summary(match_obj)
plot(match_obj, type = "jitter", interactive = FALSE)
plot(summary(match_obj))
matched_data <- match.data(match_obj)
res <- lm(psyc_distress ~ smoker, data = matched_data, weights =weights)
summary(res)
library(MatchIt)
library(lmtest)
library(sandwich)
library(tidyverse)
library(boot)
library(foreach)
library(doParallel)
cl <- parallel::makeCluster(19)
doParallel::registerDoParallel(cl)
gen_X <- function(n) {
X <- matrix(rnorm(9 * n), nrow = n, ncol = 9)
X[,5] <- as.numeric(X[,5] < .5)
X
}
#~20% treated
gen_A <- function(X) {
LP_A <- - 1.2 + log(2)*X[,1] - log(1.5)*X[,2] + log(2)*X[,4] - log(2.4)*X[,5] + log(2)*X[,7] - log(1.5)*X[,8]
#LP_A <- - 1.2 + (2)*X[,1] - (1.5)*X[,2] + (2)*X[,4] - (2.4)*X[,5] + (2)*X[,7] - (1.5)*X[,8]
P_A <- plogis(LP_A)
rbinom(nrow(X), 1, P_A)
}
# Continuous outcome
gen_Y_C <- function(A, X) {
2*A + 2*X[,1] + 2*X[,2] + 2*X[,3] + 1*X[,4] + 2*X[,5] + 1*X[,6] + rnorm(length(A), 0, 5)
}
#Conditional:
#  MD: 2
#Marginal:
#  MD: 2
# Binary outcome
gen_Y_B <- function(A, X) {
LP_B <- -2 + log(2.4)*A + log(2)*X[,1] + log(2)*X[,2] + log(2)*X[,3] + log(1.5)*X[,4] + log(2.4)*X[,5] + log(1.5)*X[,6]
P_B <- plogis(LP_B)
rbinom(length(A), 1, P_B)
}
#Conditional:
#  OR:   2.4
#  logOR: .875
#Marginal:
#  RD:    .144
#  RR:   1.54
#  logRR: .433
#  OR:   1.92
#  logOR  .655
# Survival outcome
gen_Y_S <- function(A, X) {
LP_S <- -2 + log(2.4)*A + log(2)*X[,1] + log(2)*X[,2] + log(2)*X[,3] + log(1.5)*X[,4] + log(2.4)*X[,5] + log(1.5)*X[,6]
sqrt(-log(runif(length(A)))*2e4*exp(-LP_S))
}
#Conditional:
#  HR:   2.4
#  logHR: .875
#Marginal:
#  HR:   1.57
#  logHR: .452
set.seed(19599)
n <- 5000
X <- gen_X(n)
A <- gen_A(X)
Y_C <- gen_Y_C(A, X)
Y_B <- gen_Y_B(A, X)
Y_S <- gen_Y_S(A, X)
d <- data.frame(A, X, Y_C, Y_B, Y_S)
currentDataset <- d
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$X1[currentDataset$rand > 0.95 & currentDataset$X5 == 0] = NA
currentDataset$X1[currentDataset$rand > 0.85 & currentDataset$X5 == 1] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$X3[currentDataset$rand > 0.85 & currentDataset$X5 == 0] = NA
currentDataset$X3[currentDataset$rand > 0.8 & currentDataset$X5 == 1] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$X4[currentDataset$rand > 0.85 & currentDataset$X2 >= 1] = NA
currentDataset$X4[currentDataset$rand > 0.8 & currentDataset$X2 >= 1.2] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$A[currentDataset$rand > 0.8 & currentDataset$X7 >= 1] = NA
currentDataset$A[currentDataset$rand > 0.7 & currentDataset$X7 >= 1.1] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$Y_C[currentDataset$rand > 0.85 & currentDataset$X2 >= 1] = NA
currentDataset$Y_C[currentDataset$rand > 0.8 & currentDataset$X2 >= 1.2] = NA
md.pattern(currentDataset)
library(mice)
imp <- mice(currentDataset, m =50)
cl <- parallel::makeCluster(detectCores()-1)
doParallel::registerDoParallel(cl)
currentDataset <- complete(imp, action = "long", include = TRUE)
match_obj <- NULL
res <- NULL
covar <- NULL
b <- data.frame()
m <- imp$m
coeftest_obj <- NULL
boot_res = NULL
matched_data <-NULL
for (i in (1:imp$m)) {
match_obj[[i]] <- matchit(A ~ X1 + X2 + X3+ X4+ X5+ X6+ X7+ X8+ X9,
data = currentDataset[currentDataset$.imp == i, ], method = "nearest", distance ="glm")
matched_data[[i]] <- match.data(match_obj[[i]])
res[[i]] <- lm(Y_C ~ A, data = matched_data[[i]], weights =weights)
coeftest_obj[[i]] <- coeftest(res[[i]], vcov. = vcovCL, cluster =~subclass)
b <- rbind(b, res[[i]]$coefficients)
covar[[i]] <- vcovCL(res[[i]], cluster =~ subclass)
pair_ids <- levels(matched_data[[i]]$subclass)
boot_n <- 2000
boot_res[[i]] <- foreach (k = (1:boot_n), .combine = 'rbind') %dopar% {
boot_sample_ids <- sample(pair_ids, replace = TRUE)
num_present_in_boot_sample <- table(boot_sample_ids)
ids <- unlist(lapply(pair_ids[pair_ids %in% names(num_present_in_boot_sample)],
function(p) rep(which(matched_data[[i]]$subclass == p),
num_present_in_boot_sample[p])))
boot_data <- matched_data[[i]][ids, ]
#print(boot_data)
boot_fit <- lm(Y_C ~ A , data = boot_data, weights = weights)
boot_fit$coefficients
}
boot_res[[i]] <- data.frame(boot_res[[i]])
print(i)
}
boot_res_combined <- bind_rows(boot_res, .id = NULL)
sapply(boot_res_combined, quantile, c(0.025,  0.975))
colnames(b) <- attributes(res[[1]]$coefficients)$names
U_bar <- Reduce("+", covar)/m
U_bar <- diag(U_bar)
B <- sapply(b, var)
T <- U_bar + (1 + 1/m)*B
SE <- T^0.5
est <- data.frame(var = names(b))
est$b <- sapply(b, mean)
est$SE <- SE
est$z <- est$b/est$SE
est$p_value <- pnorm(abs(est$z), lower.tail = FALSE)*2
est
mNN <- matchit(A ~ X1 + X2 + X3 + X4 + X5 +
X6 + X7 + X8 + X9, data = d)
mNN
md <- match.data(mNN)
head(md)
fit1 <- lm(Y_C ~ A, data = md, weights = weights)
fit1
est
coefci(fit1, vcov. = vcovCL, cluster =~subclass)
sapply(boot_res_combined, quantile, c(0.025,  0.975))
library(mice)
currentDataset <- d
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$X1[currentDataset$rand > 0.95 & currentDataset$X5 == 0] = NA
currentDataset$X1[currentDataset$rand > 0.85 & currentDataset$X5 == 1] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$X3[currentDataset$rand > 0.85 & currentDataset$X5 == 0] = NA
currentDataset$X3[currentDataset$rand > 0.8 & currentDataset$X5 == 1] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$X4[currentDataset$rand > 0.85 & currentDataset$X2 >= 1] = NA
currentDataset$X4[currentDataset$rand > 0.8 & currentDataset$X2 >= 1.2] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$A[currentDataset$rand > 0.8 & currentDataset$X7 >= 1] = NA
currentDataset$A[currentDataset$rand > 0.7 & currentDataset$X7 >= 1.1] = NA
currentDataset$rand = runif(length(currentDataset$A))
currentDataset$Y_C[currentDataset$rand > 0.85 & currentDataset$X2 >= 1] = NA
currentDataset$Y_C[currentDataset$rand > 0.8 & currentDataset$X2 >= 1.2] = NA
md.pattern(currentDataset)
imp <- mice(currentDataset, m =100)
cl <- parallel::makeCluster(detectCores()-1)
doParallel::registerDoParallel(cl)
currentDataset <- complete(imp, action = "long", include = TRUE)
match_obj <- NULL
res <- NULL
covar <- NULL
b <- data.frame()
m <- imp$m
coeftest_obj <- NULL
boot_res = NULL
matched_data <-NULL
for (i in (1:imp$m)) {
match_obj[[i]] <- matchit(A ~ X1 + X2 + X3+ X4+ X5+ X6+ X7+ X8+ X9,
data = currentDataset[currentDataset$.imp == i, ], method = "nearest", distance ="glm")
matched_data[[i]] <- match.data(match_obj[[i]])
res[[i]] <- lm(Y_C ~ A, data = matched_data[[i]], weights =weights)
coeftest_obj[[i]] <- coeftest(res[[i]], vcov. = vcovCL, cluster =~subclass)
b <- rbind(b, res[[i]]$coefficients)
covar[[i]] <- vcovCL(res[[i]], cluster =~ subclass)
pair_ids <- levels(matched_data[[i]]$subclass)
boot_n <- 500
boot_res[[i]] <- foreach (k = (1:boot_n), .combine = 'rbind') %dopar% {
boot_sample_ids <- sample(pair_ids, replace = TRUE)
num_present_in_boot_sample <- table(boot_sample_ids)
ids <- unlist(lapply(pair_ids[pair_ids %in% names(num_present_in_boot_sample)],
function(p) rep(which(matched_data[[i]]$subclass == p),
num_present_in_boot_sample[p])))
boot_data <- matched_data[[i]][ids, ]
#print(boot_data)
boot_fit <- lm(Y_C ~ A , data = boot_data, weights = weights)
boot_fit$coefficients
}
boot_res[[i]] <- data.frame(boot_res[[i]])
print(i)
}
boot_res_combined <- bind_rows(boot_res, .id = NULL)
sapply(boot_res_combined, quantile, c(0.025,  0.975))
colnames(b) <- attributes(res[[1]]$coefficients)$names
U_bar <- Reduce("+", covar)/m
U_bar <- diag(U_bar)
B <- sapply(b, var)
T <- U_bar + (1 + 1/m)*B
SE <- T^0.5
est <- data.frame(var = names(b))
est$b <- sapply(b, mean)
est$SE <- SE
est$z <- est$b/est$SE
est$p_value <- pnorm(abs(est$z), lower.tail = FALSE)*2
est
boot_res
?coefci
?match.data
match.data(match_obj)
match_obj[[1]]
match.data(match_obj[[1]])
kk <- match.data(match_obj[[1]])
View(kk)
kk <- get_matches(match_obj[[1]])
kk <- match.data(match_obj[[1]])
?install.packages
print("abc" + 1)
print("abc", 1)
print("abc", 2)
print(c("abc", 2))
print(paste("abc ", 2))
print(paste("abc", 2))
.liibPaths()
.libPaths(())
.libPaths()
?.libPaths()
?install.packges()
?install.packages
?foreach
?forcats
lib <- read.csv("r_libraries.csv")
for (i in 1:length(lib$package)) {
install.packages((lib$package[i]))
}
cd "C:/Users/gckc1/Documents/My programs/StatsNotebook/StatsNotebook"
cd "C:\Users\gckc1\Documents\My programs\StatsNotebook\StatsNotebook"
cd "C://Users//gckc1//Documents//My programs//StatsNotebook//StatsNotebook"
cd "C:\\Users\\gckc1\\Documents\\My programs\\StatsNotebook\\StatsNotebook"
setwd("C:\\Users\\gckc1\\Documents\\My programs\\StatsNotebook\\StatsNotebook")
lib <- read.csv("r_libraries.csv")
for (i in 1:length(lib$package)) {
install.packages((lib$package[i]))
}
